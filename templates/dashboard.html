{% extends "layout.html" %}

{% block title %}Dashboard - StudyBoiler{% endblock %}

{% block page_content %}
<div class="page text-slate-800 dark:text-slate-200">
    <!-- Hero Section -->
    <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold mb-2 text-slate-900 dark:text-white flex items-center gap-2">
                Welcome back, <span x-text="currentUser.username || 'Boilermaker'"></span>! <span
                    class="text-2xl">ðŸ‘‹</span>
            </h1>
            <div class="flex items-center gap-3 text-sm text-slate-500 dark:text-slate-400">
                <span>Today: <span class="text-slate-900 dark:text-white font-medium">0 due topics</span></span>
                <span class="w-1 h-1 bg-slate-400 dark:bg-slate-600 rounded-full"></span>
                <span><span class="text-slate-900 dark:text-white font-medium">0 min</span> studied</span>
                <span class="w-1 h-1 bg-slate-600 rounded-full"></span>
                <span>Next goal: <span class="text-[#CEB888] font-medium">20 min</span></span>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="alert('Feature coming soon: Set your exam date to track countdown.')"
                class="px-5 py-2.5 rounded-full border border-slate-600/50 text-slate-400 hover:bg-slate-800 hover:text-white transition-colors font-medium text-sm flex items-center gap-2">
                <i data-lucide="calendar" class="w-4 h-4"></i>
                Set Exam Date
            </button>
            <input type="file" id="exam-upload-input" class="hidden" @change="handleQuickUpload($event)">

            <a href="{{ url_for('study') }}"
                class="px-5 py-2.5 rounded-full bg-[#D0B991] text-black hover:bg-[#C2A070] hover:shadow-lg hover:-translate-y-0.5 transition-all font-medium text-sm flex items-center gap-2">
                <i data-lucide="play" class="w-4 h-4 fill-current"></i>
                Continue Study
            </a>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <!-- Streak -->
        <div class="surface-glass surface-glass-hover rounded-2xl p-5 relative overflow-hidden group">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">
                        Study Streak</p>
                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white max-w-[120px] truncate"
                        x-text="studyStreak ? studyStreak + ' days' : '0 days'"></h3>
                </div>
                <div
                    class="p-2 bg-[#D0B991]/10 rounded-lg text-[#D0B991] group-hover:bg-[#D0B991]/20 transition-colors">
                    <i data-lucide="flame" class="w-5 h-5"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="sparkline-placeholder opacity-60"></div>
                <!-- Empty State -->
                <p class="text-xs text-slate-500 mt-2 flex items-center gap-1"
                    x-show="!studyStreak || studyStreak == 0">
                    <span>Study 10 min today to start</span>
                </p>
                <!-- Active State -->
                <p class="text-xs text-green-400 mt-2 flex items-center gap-1" x-show="studyStreak > 0">
                    <i data-lucide="trending-up" class="w-3 h-3"></i> Keep it up!
                </p>
            </div>
        </div>

        <!-- Accuracy -->
        <div class="surface-glass surface-glass-hover rounded-2xl p-5 relative overflow-hidden group">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">
                        Accuracy</p>
                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white" x-text="(accuracy || 0) + '%'"></h3>
                </div>
                <div
                    class="p-2 bg-[#D0B991]/10 rounded-lg text-[#D0B991] group-hover:bg-[#D0B991]/20 transition-colors">
                    <i data-lucide="target" class="w-5 h-5"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="sparkline-placeholder opacity-60 mb-2" x-show="accuracy > 0"></div>
                <div class="w-full bg-slate-700/50 h-1.5 rounded-full overflow-hidden" x-show="accuracy > 0">
                    <div class="bg-[#D0B991] h-full rounded-full" :style="'width: ' + (accuracy || 0) + '%'"></div>
                </div>
                <!-- Empty State -->
                <div class="flex items-center gap-2 mt-2" x-show="!accuracy">
                    <div class="h-1.5 w-16 bg-slate-700/50 rounded-full"></div>
                    <span class="text-xs text-slate-500">Answer 10 Qs to measure</span>
                </div>
            </div>
        </div>

        <!-- Mastered -->
        <div class="surface-glass surface-glass-hover rounded-2xl p-5 relative overflow-hidden group">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">
                        Mastered</p>
                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white"
                        x-text="(masteredTopics || 0) + '/' + (allTopics.length || 0)"></h3>
                </div>
                <div
                    class="p-2 bg-[#9D9796]/10 rounded-lg text-[#9D9796] group-hover:bg-[#9D9796]/20 transition-colors">
                    <i data-lucide="award" class="w-5 h-5"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="sparkline-placeholder opacity-60 mb-2" x-show="allTopics.length > 0"></div>
                <!-- Empty State -->
                <p class="text-xs text-slate-500 mt-2" x-show="allTopics.length === 0">Upload exam to detect topics</p>
                <p class="text-xs text-emerald-400" x-show="allTopics.length > 0 && masteredTopics > 0">You're making
                    progress!</p>
            </div>
        </div>

        <!-- Exam Countdown -->
        <div class="surface-glass surface-glass-hover rounded-2xl p-5 relative overflow-hidden group">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">
                        Until Exam</p>
                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white"
                        x-text="daysUntilExam ? daysUntilExam + ' days' : '--'">
                    </h3>
                </div>
                <div class="p-2 bg-blue-500/10 rounded-lg text-blue-400 group-hover:bg-blue-500/20 transition-colors">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                </div>
            </div>
            <div class="mt-4">
                <!-- Empty State -->
                <p class="text-xs text-slate-500 flex items-center gap-1" x-show="!daysUntilExam">
                    <span>Set an exam date</span>
                </p>
                <p class="text-xs text-blue-400" x-show="daysUntilExam">Get ready!</p>
            </div>
        </div>
    </div>

    <!-- Row 1: Retention & Study Together -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
        <!-- Retention Graph (8 cols) -->
        <div
            class="lg:col-span-8 surface-glass rounded-3xl p-6 border border-white/5 relative flex flex-col min-h-[300px]">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-slate-800 rounded-lg border border-slate-700">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 text-[#D0B991]"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Retention Progress</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400">Estimated memory decay over time</p>
                    </div>
                </div>
                <!-- Optional Timeframe Selector if implemented -->
            </div>

            <!-- Empty State for Chart -->
            <!-- Empty State for Chart -->
            <div x-show="!hasRetentionData"
                class="flex-1 flex flex-col items-center justify-center text-center p-8 border-2 border-dashed border-slate-700/50 rounded-2xl bg-slate-800/20 relative overflow-hidden">
                <!-- Faint Background Chart -->
                <svg class="absolute inset-0 w-full h-full opacity-[0.03] pointer-events-none" viewBox="0 0 100 40"
                    preserveAspectRatio="none">
                    <path d="M0,40 Q25,20 50,30 T100,10 L100,40 Z" fill="currentColor" class="text-[#9D9796]"></path>
                </svg>

                <div
                    class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 shadow-inner relative z-10">
                    <i data-lucide="line-chart" class="w-8 h-8 text-slate-600"></i>
                </div>
                <h4 class="text-slate-300 font-medium mb-1 relative z-10">No retention data yet</h4>
                <p class="text-slate-500 text-sm max-w-xs mb-6 relative z-10">Complete your first study session to
                    verify your retention curve.</p>
                <a href="{{ url_for('study') }}"
                    class="relative z-10 px-5 py-2.5 bg-[#D0B991] text-black rounded-full hover:bg-[#C2A070] transition-colors font-medium text-sm shadow-lg shadow-[#D0B991]/20 flex items-center gap-2">
                    Start Studying <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </a>
            </div>

            <!-- Real Chart -->
            <canvas id="retention-chart" class="w-full h-full hidden"></canvas>
        </div>

        <!-- Study Together (4 cols) -->
        <div
            class="lg:col-span-4 surface-glass rounded-3xl p-6 border border-white/5 relative overflow-hidden flex flex-col justify-between group">
            <!-- Decorative background elements -->
            <div class="absolute top-0 right-0 w-32 h-32 bg-[#D0B991]/10 blur-3xl rounded-full pointer-events-none">
            </div>

            <div>
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="relative flex h-2.5 w-2.5">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                        </span>
                        <span class="text-xs font-medium text-green-400 uppercase tracking-widest">Live Now</span>
                    </div>
                    <span class="text-xs text-slate-500 bg-slate-800/50 px-2 py-1 rounded">2 sessions open</span>
                </div>

                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Study Together</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Join 12 other Boilermakers studying right
                    now.</p>

                <!-- Avatar Stack -->
                <div class="flex -space-x-3 mb-6">
                    <div
                        class="w-10 h-10 rounded-full border-2 border-[#0f172a] bg-slate-700 flex items-center justify-center text-xs text-white z-30">
                        JD</div>
                    <div
                        class="w-10 h-10 rounded-full border-2 border-[#0f172a] bg-indigo-600 flex items-center justify-center text-xs text-white z-20">
                        AS</div>
                    <div
                        class="w-10 h-10 rounded-full border-2 border-[#0f172a] bg-purple-600 flex items-center justify-center text-xs text-white z-10">
                        MR</div>
                    <div
                        class="w-10 h-10 rounded-full border-2 border-[#0f172a] bg-slate-800 flex items-center justify-center text-xs text-slate-400 z-0 text-[10px]">
                        +9</div>
                </div>
            </div>

            <div>
                <a href="{{ url_for('group_study') }}"
                    class="block w-full bg-slate-900/10 dark:bg-white/10 hover:bg-slate-900/20 dark:hover:bg-white/20 hover:scale-[1.02] border border-black/5 dark:border-white/5 backdrop-blur text-slate-900 dark:text-white py-3 rounded-xl transition-all font-medium text-center mb-3">
                    Join Session
                </a>
                <a href="#" class="block text-center text-xs text-slate-500 hover:text-slate-300 transition-colors">
                    Browse active groups
                </a>
            </div>
        </div>
    </div>

    <!-- Row 2: Leaderboard & Progress -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-12">
        <!-- Leaderboard (8 cols) -->
        <div id="leaderboard-section" class="lg:col-span-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Leaderboard</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Competing with <span
                            class="text-slate-700 dark:text-slate-200">Engineering</span>
                        students</p>
                </div>

                <!-- Pill Filters -->
                <div
                    class="flex bg-slate-100 dark:bg-slate-800/50 rounded-full p-1 border border-black/5 dark:border-white/5">
                    <button @click="leaderboardPeriod = 'week'; loadLeaderboard()"
                        :class="leaderboardPeriod === 'week' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'"
                        class="px-4 py-1.5 rounded-full text-xs font-medium transition-all">
                        This Week
                    </button>
                    <button @click="leaderboardPeriod = 'alltime'; loadLeaderboard()"
                        :class="leaderboardPeriod === 'alltime' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'"
                        class="px-4 py-1.5 rounded-full text-xs font-medium transition-all">
                        All Time
                    </button>
                </div>
            </div>

            <!-- Podium -->
            <div class="grid grid-cols-3 gap-4 items-end mb-8 min-h-[200px]" id="podium-container">
                <!-- Populated by JS -->
                <div class="col-span-3 flex items-center justify-center text-slate-500 text-sm h-full">
                    Loading rankings...
                </div>
            </div>

            <!-- List View -->
            <div class="bg-slate-800/30 rounded-2xl border border-white/5 divide-y divide-white/5 overflow-hidden"
                id="leaderboard-list">
                <!-- Entries populated by JS -->
            </div>
        </div>

        <!-- Local Stats / Progress (4 cols) -->
        <div class="lg:col-span-4 space-y-6">
            <div class="surface-glass rounded-3xl p-6 border border-black/5 dark:border-white/5">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Your Progress</h3>

                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-500 dark:text-slate-400">Current Rank</span>
                    <span class="text-xl font-bold text-slate-900 dark:text-white"
                        x-text="'#' + (myRank || '-')"></span>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between text-xs mb-1.5">
                        <span class="text-slate-500">Next Rank: #<span x-text="(myRank - 1) || 1"></span></span>
                        <span class="text-[#9B72CF]">120 XP to go</span>
                    </div>
                    <div class="h-2 bg-slate-700/50 rounded-full overflow-hidden">
                        <div
                            class="h-full w-[70%] bg-gradient-to-r from-[#D0B991] to-[#C2A070] rounded-full shadow-[0_0_10px_rgba(208,185,145,0.5)]">
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/5">
                        <div class="p-2 bg-[#D0B991]/20 rounded-lg text-[#D0B991]">
                            <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-white">Complete 1 quiz</p>
                            <p class="text-xs text-slate-500">Daily Goal</p>
                        </div>
                        <button
                            class="ml-auto text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded-full transition-colors">
                            Go
                        </button>
                    </div>

                    <!-- Merged Rivalry Section -->
                    <div
                        class="p-3 rounded-xl bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 relative overflow-hidden">
                        <div class="flex items-start justify-between gap-2 relative z-10">
                            <div>
                                <p
                                    class="text-xs text-amber-600 dark:text-amber-200/80 mb-1 font-medium uppercase tracking-wider">
                                    Rivalry
                                </p>
                                <p class="text-sm text-slate-700 dark:text-slate-300">
                                    Only <span class="text-slate-900 dark:text-white font-bold">40 XP</span> behind
                                    <span class="text-[#CEB888]">Sam_Purdue</span>
                                </p>
                            </div>
                            <div class="p-1.5 bg-amber-500/20 rounded-lg">
                                <i data-lucide="swords" class="w-4 h-4 text-amber-400"></i>
                            </div>
                        </div>
                        <button
                            class="w-full mt-3 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 py-1.5 rounded-lg transition-colors border border-white/5">
                            View Rivalry
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Heatmap Full Width -->
    <div id="heatmap-section" class="mb-12">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="map-pin" class="w-6 h-6 text-[#D0B991]"></i> Campus Heatmap
                </h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Live study activity across campus</p>
            </div>
            <!-- Legend as Pills -->
            <div class="hidden md:flex gap-2">
                <span
                    class="px-3 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">Low
                    (1-10)</span>
                <span
                    class="px-3 py-1 rounded-full text-xs font-medium bg-amber-500/10 text-amber-400 border border-amber-500/20">Med
                    (11-25)</span>
                <span
                    class="px-3 py-1 rounded-full text-xs font-medium bg-rose-500/10 text-rose-400 border border-rose-500/20">High
                    (26+)</span>
            </div>
        </div>

        <!-- Filter Row -->
        <div class="flex items-center gap-2 mb-4 px-1">
            <span class="text-xs text-slate-500 mr-2 uppercase tracking-wider font-medium">Timeframe:</span>
            <button @click="heatmapTimeFilter = 'now'; loadHeatmapData()"
                :class="heatmapTimeFilter === 'now' ? 'bg-[#D0B991] text-black shadow-lg shadow-[#D0B991]/20' : 'bg-slate-800/50 text-slate-400 hover:text-white hover:bg-slate-700'"
                class="px-4 py-1.5 rounded-full text-xs font-medium transition-all border border-white/5">
                Live Now
            </button>
            <button @click="heatmapTimeFilter = '24h'; loadHeatmapData()"
                :class="heatmapTimeFilter === '24h' ? 'bg-[#D0B991] text-black shadow-lg shadow-[#D0B991]/20' : 'bg-slate-800/50 text-slate-400 hover:text-white hover:bg-slate-700'"
                class="px-4 py-1.5 rounded-full text-xs font-medium transition-all border border-white/5">
                Past 24h
            </button>
            <button @click="heatmapTimeFilter = 'week'; loadHeatmapData()"
                :class="heatmapTimeFilter === 'week' ? 'bg-[#D0B991] text-black shadow-lg shadow-[#D0B991]/20' : 'bg-slate-800/50 text-slate-400 hover:text-white hover:bg-slate-700'"
                class="px-4 py-1.5 rounded-full text-xs font-medium transition-all border border-white/5">
                Past Week
            </button>
        </div>

        <div class="heatmap-container relative h-[500px] w-full">
            <!-- Map Layer -->
            <div class="absolute inset-0 bg-[#1e293b]/50">
                <!-- Placeholder Shimmer when loading -->
                <div class="absolute inset-0 map-placeholder-shimmer opacity-20 pointer-events-none"
                    x-show="!studyLocations.length"></div>

                <!-- Center Text if Empty -->
                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10"
                    x-show="!studyLocations.length">
                    <div
                        class="p-4 bg-slate-900/80 backdrop-blur rounded-2xl border border-white/10 text-center shadow-2xl">
                        <i data-lucide="map" class="w-8 h-8 text-slate-500 mx-auto mb-2"></i>
                        <p class="text-slate-300 font-medium">Map visualization loading...</p>
                        <p class="text-xs text-slate-500">(Using 2D placeholders for now)</p>
                    </div>
                </div>

                <!-- Locations Dots (visualizing the data) -->
                <template x-for="loc in studyLocations" :key="loc.id">
                    <div class="absolute w-4 h-4 rounded-full shadow-[0_0_10px_currentColor] border-2 border-white cursor-pointer hover:scale-150 hover:z-30 transition-all z-20 group"
                        :class="{
                             'bg-emerald-500 text-emerald-500': loc.students <= 10,
                             'bg-amber-500 text-amber-500': loc.students > 10 && loc.students <= 25,
                             'bg-rose-500 text-rose-500': loc.students > 25
                         }" :style="`left: ${loc.x}%; top: ${loc.y}%;`"
                        @click="document.getElementById('loc-item-' + loc.id)?.scrollIntoView({behavior: 'smooth', block: 'center'});">

                        <!-- Tooltip -->
                        <div
                            class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1.5 bg-slate-900 border border-white/10 text-white text-xs whitespace-nowrap rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                            <span class="font-bold" x-text="loc.name"></span> â€¢ <span
                                x-text="loc.students + ' studying'"></span>
                        </div>
                    </div>
                    <!-- Label -->
                    <span
                        class="absolute text-[10px] font-bold text-slate-400/70 pointer-events-none whitespace-nowrap z-10"
                        :style="`left: ${loc.x}%; top: ${loc.y}%; transform: translate(-50%, 14px);`"
                        x-text="loc.building_code || loc.name.substring(0,4).toUpperCase()"></span>
                </template>
            </div>

            <!-- Floating List Overlay (Right Side) -->
            <div
                class="absolute right-4 top-4 bottom-4 w-72 bg-slate-900/90 backdrop-blur-md rounded-2xl border border-white/10 overflow-hidden flex flex-col shadow-2xl">
                <div class="p-4 border-b border-white/5 bg-slate-800/50">
                    <h3 class="text-sm font-bold text-white">Top Locations</h3>
                    <p class="text-xs text-slate-400">Sorted by activity</p>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                    <template x-for="loc in studyLocations.sort((a,b) => b.students - a.students)" :key="loc.id">
                        <div :id="'loc-item-' + loc.id"
                            class="p-3 rounded-xl hover:bg-white/5 transition-colors group cursor-pointer border border-transparent hover:border-white/5">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-slate-200 group-hover:text-white truncate"
                                    x-text="loc.name"></span>
                                <span x-show="loc.hot"
                                    class="text-[10px] bg-rose-500/20 text-rose-400 px-1.5 py-0.5 rounded">HOT</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-slate-500">
                                <div class="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-indigo-500 rounded-full"
                                        :style="`width: ${(loc.students / 50) * 100}%`"></div>
                                </div>
                                <span x-text="loc.students"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Component specific scripts or overrides
    function handleQuickUpload(event) {
        // Logic to trigger the main upload flow
        const file = event.target.files[0];
        if (file) {
            // Check if app() scope is available, or redirect
            window.location.href = "{{ url_for('documents') }}";
        }
    }
</script>
{% endblock %}