{% extends "layout.html" %}

{% block content %}
<div class="px-6 py-8 animate-fade-in" x-data="{ 
    showTopics: false, 
    topics: [], 
    loading: false, 
    currentCourse: '' 
}">
    <!-- Topics Modal -->
    <div x-show="showTopics" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-transition.opacity>
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-lg mx-4 overflow-hidden border border-slate-200 dark:border-slate-700"
            @click.away="showTopics = false" x-transition.scale.origin.top>
            <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-900 dark:text-white">Study <span x-text="currentCourse"></span>
                </h3>
                <button @click="showTopics = false"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <div x-show="loading" class="text-center py-8 text-slate-500">
                    <i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
                    Loading topics...
                </div>
                <div x-show="!loading && topics.length === 0" class="text-center py-8 text-slate-500">
                    No topics found for this course yet.
                </div>
                <div x-show="!loading && topics.length > 0" class="space-y-2">
                    <template x-for="topic in topics" :key="topic.topic_id">
                        <a :href="'/study?topic=' + encodeURIComponent(topic.topic_id)"
                            class="block p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border border-transparent hover:border-slate-200 dark:hover:border-slate-600 group">
                            <div class="flex items-center justify-between">
                                <span x-text="topic.name"
                                    class="font-medium text-slate-700 dark:text-slate-200 group-hover:text-indigo-600 dark:group-hover:text-indigo-400"></span>
                                <i data-lucide="chevron-right"
                                    class="w-4 h-4 text-slate-400 group-hover:text-indigo-500"></i>
                            </div>
                        </a>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Header with Add Course -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">My Courses</h1>
            <p class="text-slate-500 dark:text-slate-400">Manage your courses and access exams.</p>
        </div>

        <div x-data="{ 
            isAdding: false, 
            newCourseName: '', 
            availableCourses: [],
            async init() {
                try {
                    const res = await fetch('/api/courses');
                    const data = await res.json();
                    if(data.success) {
                        this.availableCourses = data.courses;
                    }
                } catch(e) {
                    console.error('Failed to load courses', e);
                }
            },
            async addCourse() {
                if (!this.newCourseName) return;
                try {
                    const res = await fetch('/api/add-course', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({course_name: this.newCourseName})
                    });
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        const data = await res.json();
                        alert(data.error);
                    }
                } catch(e) {
                    alert('Error adding course');
                }
            }
        }">
            <div x-show="!isAdding">
                <button @click="isAdding = true; $nextTick(() => $refs.input.focus())"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> Add Course
                </button>
            </div>
            <div x-show="isAdding" class="flex items-center gap-2" x-cloak>
                <input x-ref="input" type="text" x-model="newCourseName" @keydown.enter="addCourse()"
                    @keydown.escape="isAdding=false" placeholder="e.g. CS 101" list="course-options"
                    class="border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-800 text-slate-900 dark:text-white">

                <datalist id="course-options">
                    <template x-for="course in availableCourses" :key="course">
                        <option :value="course"></option>
                    </template>
                </datalist>

                <button @click="addCourse()" class="text-indigo-600 hover:text-indigo-700 p-2"><i data-lucide="check"
                        class="w-4 h-4"></i></button>
                <button @click="isAdding=false" class="text-slate-400 hover:text-slate-500 p-2"><i data-lucide="x"
                        class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    {% if not courses %}
    <div class="text-center py-12 bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700">
        <div
            class="w-16 h-16 bg-indigo-50 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="book-open" class="w-8 h-8 text-indigo-500"></i>
        </div>
        <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-2">No courses yet</h3>
        <p class="text-slate-500 max-w-sm mx-auto">Add a course code (like "CS 101") to see exams shared by your class.
        </p>
    </div>
    {% else %}

    <div class="space-y-8">
        {% for course in courses %}
        <div
            class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div
                class="bg-slate-50 dark:bg-slate-900/50 px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="graduation-cap" class="w-5 h-5 text-indigo-500"></i>
                    {{ course.name }}
                </h2>
                <button
                    @click="currentCourse = '{{ course.name }}'; showTopics = true; loading = true; fetch('/api/course/' + encodeURIComponent('{{ course.name }}') + '/topics').then(r => r.json()).then(d => { topics = d.topics; loading = false; })"
                    class="text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 hover:underline flex items-center gap-1">
                    <i data-lucide="list-tree" class="w-4 h-4"></i>
                    Study by Topic
                </button>
            </div>

            <div class="p-6">
                {% if not course.exams %}
                <p class="text-slate-400 text-sm italic">No exams available for this course yet.</p>
                {% else %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for exam in course.exams %}
                    <div
                        class="surface-card p-4 hover:border-indigo-500/50 transition-colors group relative border border-slate-200 dark:border-slate-700 rounded-xl">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-semibold text-slate-900 dark:text-white">{{ exam.name }}</h4>
                                <p class="text-xs text-slate-500">{{ exam.type }} â€¢ {{ exam.year }}</p>
                            </div>
                            <span class="text-xs text-slate-400">{{ exam.date }}</span>
                        </div>

                        <div
                            class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                            <div class="text-xs text-slate-500">
                                <span class="font-medium text-slate-900 dark:text-white">{{ exam.questions }}</span>
                                questions
                            </div>
                            <div class="flex gap-2">
                                <a href="{{ url_for('exam_detail', exam_id=exam.id) }}"
                                    class="inline-flex items-center px-3 py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 text-xs font-medium rounded-full hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors">
                                    Solve
                                </a>

                                {% if exam.is_owner %}
                                <a href="{{ url_for('edit_exam', exam_id=exam.id) }}"
                                    class="inline-flex items-center px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-medium rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                                    Edit
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% endif %}
</div>
{% endblock %}